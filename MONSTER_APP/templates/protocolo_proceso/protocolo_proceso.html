{% extends "partial/body.html" %}
{% block stylesheet %}
  
{% endblock stylesheet %}
{% block contenido %}
{% include "partial/loadingPaginas.html" %}

<script src="https://unpkg.com/gijgo@1.9.14/js/gijgo.min.js" type="text/javascript"></script>
<link href="https://unpkg.com/gijgo@1.9.14/css/gijgo.min.css" rel="stylesheet" type="text/css" />


<div id="contenido-cargado" class="d-none">
  <!-- TODO TODO: Todo tu contenido actual (container-fluid, card, tabla, etc.) aquí adentro -->
  <div class="container-fluid">
    <div class="pagetitle"><br>
      <h4 class="">Gestión de Protocolos de Proceso</h4><br>
    </div>
    <div class="card">
      <div class="container-fluid">
        <!-- contenido de filas, botones, etc. -->
      </div>
      <div class="card-body table-responsive">
        <table id="example3" class="display" style="width:100%">
          <thead>
            <tr>
              <th style="width: 20%">Código del Protocolo</th>
              <th style="width: 35%">Nombre</th>
              <th style="width: 8%" class="text-left">Estado</th>
              <th class="all text-center">Opciones</th>
              <th class="d-none">Detalles</th> 
            </tr>
          </thead>
          <tbody id="myTable"></tbody>
        </table>
                <link href="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.3/b-3.0.1/b-html5-3.0.1/date-1.5.2/sl-2.0.0/datatables.min.css" rel="stylesheet">
 
        <script src="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.3/b-3.0.1/b-html5-3.0.1/date-1.5.2/sl-2.0.0/datatables.min.js"></script>

      </div>
    </div>
  </div>
</div>
<style>
  table#example3 tr.d-none {
    display: none !important;
  }
</style>

<style>
  .rotate-icon {
    transform: rotate(180deg);
    transition: transform 0.3s ease;
  }
  .bg-light {
    background-color: #f8f9fa !important;
  }
</style>

<script src="https://cdn.datatables.net/v/dt/jq-3.7.0/dt-2.0.3/b-3.0.1/b-html5-3.0.1/date-1.5.2/sl-2.0.0/datatables.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const spinner = document.getElementById('spinner-carga');
  const contenido = document.getElementById('contenido-cargado');
  const tbody = document.getElementById('myTable');

   const urlParams = new URLSearchParams(window.location.search);
  const skipSpinner = urlParams.get('skipSpinner') === '1';

  if (!skipSpinner) {
    spinner.classList.remove('d-none');
    contenido.classList.add('d-none');
  } else {
    // Mostrar directamente el contenido si venimos de redirección
    spinner.classList.add('d-none');
    contenido.classList.remove('d-none');
  }

fetch("{% url 'protocolo_proceso_json' %}")
  .then(response => response.json())
  .then(data => {
    const table = new DataTable('#example3', {
      data: data,
      columns: [
        {
          data: null,
          render: function (p) {
            return `
              <a>${p.codigo}</a><br>
              <small>Fecha de estado actual: ${p.fecha_final}</small>
            `;
          }
        },
        {
          data: 'nombre'
        },
        {
          data: null,
          render: function (p) {
            let entregaHTML = '';
            if (p.estado_del_proceso?.nombre.toLowerCase().includes("finalizado") && p.fecha_de_entrega) {
              entregaHTML = `<br><small class="text-muted">Entregado el ${p.fecha_de_entrega}</small>`;
            }
            return `${getEstadoBadge(p.estado_del_proceso?.id, p.estado_del_proceso?.nombre)} ${entregaHTML}`;
          }
        },
        {
          data: null,
          orderable: false,
          render: function (p) {
            let entregadoAHTML = '';
            if (p.estado_del_proceso?.nombre.toLowerCase().includes("finalizado") && p.fecha_de_entrega) {
              entregadoAHTML = `<strong>Entregado a:</strong> ${p.entregado_a || ''}`;
            }

            const detalle = `
              <strong>Cliente:</strong> ${p.cliente || ''}<br>
              <strong>Celda:</strong> ${p.celda?.nombre || ''} (${p.celda?.responsable || ''})<br>
              <strong>Método:</strong> ${p.metodo?.código || ''} - ${p.metodo?.nombre || ''}<br>
              <strong>Observaciones:</strong> ${p.observaciones || ''}<br>
              ${entregadoAHTML}
            `;

            return `
              <button class="btn btn-outline-secondary btn-sm toggle-details" data-detalle="${encodeURIComponent(detalle)}" title="Mostrar detalles">
                <i class="fas fa-chevron-down me-1 toggle-icon"></i> Expandir
              </button>
              <a class="btn btn-primary btn-sm" href="/revisar_protocolo_proceso/${p.id}">
                <i class="fas fa-folder"></i> Revisar
              </a>
              ${isAdmin() ? `
              <a class="btn btn-info btn-sm" href="/editar_protocolo_proceso/${p.id}">
                <i class="fas fa-pencil-alt"></i> Editar
              </a>` : ''}
            `;
          }
        },
        {
          data: null,
          visible: false,
          searchable: true,
          render: function (p) {
            return [
              p.cliente,
              p.celda?.nombre,
              p.celda?.responsable,
              p.metodo?.código,
              p.metodo?.nombre,
              p.observaciones,
              p.entregado_a
            ].join(' ').toLowerCase();
          }
        }
      ],
      searching: true,
      paging: true,
      lengthChange: true,
      info: false,
      autoWidth: true,
      responsive: true,
    });

    // Delegación segura de eventos (para paginación/filtrado)
$('#example3 tbody').on('click', '.toggle-details', function () {
  const tr = $(this).closest('tr');
  const row = table.row(tr);
  const icon = $(this).find('i');

  if (row.child.isShown()) {
    row.child.hide();
    tr.removeClass('shown');
    icon.removeClass('rotate-icon');
    $(this).contents().last().replaceWith(' Expandir');
  } else {
    const detalleHTML = decodeURIComponent($(this).data('detalle'));
    row.child(`<div class="bg-light p-3">${detalleHTML}</div>`).show();
    tr.addClass('shown');
    icon.addClass('rotate-icon');
    $(this).contents().last().replaceWith(' Ocultar');
  }
});

    spinner.classList.add('d-none');
    contenido.classList.remove('d-none');
  })
  .catch(error => {
    console.error("Error al cargar los datos:", error);
    spinner.innerHTML = `<p class="text-danger">Error al cargar los datos.</p>`;
  });

  function getEstadoBadge(id, nombre) {
    if (id === 5) return `<span class="badge badge-secondary">${nombre}</span>`;
    if (id === 6) return `<span class="badge badge-info">${nombre}</span>`;
    if ([2, 3, 4].includes(id)) return `<span class="badge bg-gradient-warning text-body">${nombre}</span>`;
    if (id === 1) return `<span class="badge badge-success">${nombre}</span>`;
    return nombre;
  }

  function isAdmin() {
    return "{{ is_admin|yesno:'true,false' }}" === "true";
  }
});

//Mensaje de exito cuando se redirige desde el formulario
 const mensaje = sessionStorage.getItem('protocoloSuccess');
  if (mensaje) {
    Swal.fire({
      icon: 'success',
      title: 'Éxito',
      text: mensaje,
      timer: 2500,
      showConfirmButton: false
    });
    sessionStorage.removeItem('protocoloSuccess');
  }

</script>
{% endblock contenido %}
